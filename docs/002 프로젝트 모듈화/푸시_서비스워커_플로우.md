# 푸시 & 서비스워커 플로우 메모 (2026-02-03)

## 서비스워커 등록
- `src/main.tsx`: `import.meta.env.PROD` && `serviceWorker` 지원 시에만 `/sw.js` 등록.
- 개발/Mock(`VITE_USE_MOCK_API=true`)에서는 등록하지 않으므로 푸시 토큰 발급 시도 자체가 일어나지 않음.

## FCM 설정
- `src/firebase/config.ts`: `.env` 기반(Firebase VITE_* 키)으로 읽어오며 프로덕션에서만 유효. 값이 없으면 경고 후 `null`을 반환해 초기화를 차단.
- VAPID 키: `VITE_FIREBASE_VAPID_KEY` 또는 서버 `/v0/push/vapid` 응답으로 주입.

## 푸시 구독 흐름(`usePushSubscription`)
1) 환경 지원 & 권한 확인 → 미지원/차단 시 상태 메시지 제공.
2) 서비스워커 레지스트리 확보(프로덕션 한정) 후 FCM 토큰을 한 번만 로깅(`logFcmTokenOnce`).
3) 원격 구독 상태 확인 → 없거나 불일치하면 재구독 안내/자동 로그 출력.
4) 구독/해지 시 서버 API(`push/subscribe`, `push/unsubscribe`) 호출 후 브라우저 구독 동기화.

## 모의 환경 주의
- Dev/Mock에서는 service worker가 없으므로 `usePushSubscription`이 `unsupported` 또는 `error` 상태를 반환할 수 있음. 테스트는 프로덕션 빌드(`npm run preview`)에서 진행.
